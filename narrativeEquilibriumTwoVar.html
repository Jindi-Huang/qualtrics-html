<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Button Game</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: white;
}

.game-container {
    display: flex;
    max-width: 650px;
    margin: 20px auto;
    gap: 15px;
    align-items: flex-start;
    justify-content: center;
}

.panels-section {
    flex: 1;
    min-width: 500px;
    max-width: 500px;
}

.roundDisplay {
    font-size: 18px;
    text-align: center;
    padding: 10px 0;
    margin-bottom: 10px;
    color: #333;
    font-weight: bold;
}

.panel {
    position: relative;
    width: 100%;
    height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 10px;
    border: 1px solid black;
}

.panel-header {
    position: absolute;
    top: 8px;
    left: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.panel-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.panel-name {
    font-weight: bold;
    font-size: 20px;
    color: #333;
}

.text {
    text-align: center;
    font-size: 18px;
    padding: 8px;
    color: #333;
    margin-top: 0;
}

.button-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
}

.actionButton {
    padding: 8px 16px;
    margin: 0;
    font-size: 16px;
    cursor: pointer;
    border: none;
    color: white;
    border-radius: 4px;
    transition: background-color 0.3s, transform 0.2s;
    width: 150px;
    text-align: center;
}

.actionButton:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.actionButton:hover.grayed-out {
    transform: none;
    box-shadow: none;
}

.green { background-color: #4CAF50; }
.red { background-color: #f44336; }
.grayed-out { 
    background-color: #cccccc !important; 
    color: #666666 !important; 
    cursor: not-allowed !important;
}
.hidden { display: none; }

.flash {
    outline: 3px solid orange;
    transition: outline 0.2s ease;
}

</style>
</head>

<body>
    <div id="gameContainer" class="game-container" style="display: none;">
        <div class="panels-section">
            <div id="roundDisplay" class="roundDisplay"></div>
            
            <div id="panelAchoice" class="panel">
                <div class="panel-header">
                    <div class="panel-name">You</div>
                </div>
                <div id="actionPrompt" class="text">Press your button?</div>
                <div class="button-container">
                    <button id="btnNo" class="actionButton red">No (free)</button>
                    <button id="btnYes" class="actionButton green">Yes (cost $0.25)</button>
                </div>
            </div>
            
            <div id="panelXinfo" class="panel">
                <div class="panel-header">
                    <img src="https://via.placeholder.com/40/4CAF50/FFFFFF?text=P1" class="panel-icon" alt="Player">
                    <div class="panel-name">Player A</div>
                </div>
                <div id="resultText" class="text">(press "space" to continue)</div>
            </div>
        </div>
    </div>

<script>
    
/* ===================== DEFAULT CONFIGURATION ===================== */
let gameConfig = {
    nRounds: 20,
    id: 1,
    aCost: 0.25,
    playerName1: "Player A",
    playerPronoun1: "their",
    playerIcon1: "https://via.placeholder.com/40/4CAF50/FFFFFF?text=P1",
    currentHue: 200,
    pA: 0.5, 
    pX_A1: 0.8, // Probability X=1 when A=1
    pX_A0: 0.2  // Probability X=1 when A=0
};

let participantId = null;

/* ========================= GAME STATE ========================= */
let roundCounter = 0;
let X, A;
let history = [];
let roundTimes = [];
let roundStartTime = 0;
let resultDisplayed = false;

/* ========================== DOM ELEMENTS ========================== */
const gameContainer = document.getElementById("gameContainer");
const btnNo = document.getElementById("btnNo");
const btnYes = document.getElementById("btnYes");
const panelXinfo = document.getElementById("panelXinfo");
const panelAchoice = document.getElementById("panelAchoice");
const resultText = document.getElementById("resultText");
const roundDisplay = document.getElementById("roundDisplay");

/* =============== QUALTRICS COMMUNICATION =============== */
function sendDataToQualtrics(dataType, data) {
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'GAME_DATA',
            dataType: dataType,
            data: data,
            participantId: participantId,
            timestamp: new Date().toISOString()
        }, '*');
    }
}

window.addEventListener('message', function(event) {
    if (event.data.type === 'INIT') {
        participantId = event.data.participantId;
        if (event.data.gameConfig) {
            Object.assign(gameConfig, event.data.gameConfig);
            applyGameConfiguration();
        }
    }
});

/* =============== HELPER FUNCTIONS =============== */

function applyGameConfiguration() {
    btnYes.textContent = `Yes (cost $${gameConfig.aCost})`;
    
    const elements = {
        playerName1: document.querySelector('#panelXinfo .panel-name'),
        playerIcon1: document.querySelector('#panelXinfo .panel-icon')
    };
    
    if (elements.playerName1) elements.playerName1.textContent = gameConfig.playerName1;
    if (elements.playerIcon1) elements.playerIcon1.src = gameConfig.playerIcon1;
    
    document.body.style.background = `hsl(${gameConfig.currentHue} 70% 85%)`;
}

/* ===================== GAME LOGIC ===================== */
function handleDecision(decision) {
    if (panelAchoice.style.display !== 'flex') return;
    
    btnYes.disabled = btnNo.disabled = true;
    const selectedBtn = decision === 'y' ? btnYes : btnNo;
    selectedBtn.classList.add("flash");
    setTimeout(() => selectedBtn.classList.remove("flash"), 200);

    A = decision === 'y' ? 1 : 0;
    
    // Generate X based on A with the configured probabilities
    const pX = A === 1 ? gameConfig.pX_A1 : gameConfig.pX_A0;
    X = Math.random() < pX ? 1 : 0;

    history.push([A, X]);
    
    resultDisplayed = false;

    setTimeout(() => {
        panelXinfo.style.backgroundColor = X ? "green" : "red";
        resultText.innerHTML = X
            ? `<br>${gameConfig.playerName1} pressed ${gameConfig.playerPronoun1} button <br>(press "space" to continue)`
            : `<br>${gameConfig.playerName1} did <u>not</u> press ${gameConfig.playerPronoun1} button <br>(press "space" to continue)`;
        panelXinfo.style.display = "flex";
        resultDisplayed = true;
    }, 200);
}

function handleKeyPress(e) {
    if (e.key === ' ' && resultDisplayed) {
        roundTimes.push((Date.now() - roundStartTime) / 1000);
        if (roundCounter <= gameConfig.nRounds) {
            nextRound();
            resultDisplayed = false;
        }
    }
}

function nextRound() {
    if (roundCounter < gameConfig.nRounds) {
        roundCounter++;
        roundDisplay.textContent = `Round ${roundCounter} of ${gameConfig.nRounds}`;
        
        // Hide panels first to create refresh effect
        panelAchoice.style.display = "none";
        panelXinfo.style.display = "none";
        
        setTimeout(showActionPanels, 500);
    } else {

        sendDataToQualtrics('FINAL_DATA', {
            history: history,
            roundTimes: roundTimes,
            config: gameConfig
        });
        
        sendDataToQualtrics('GAME_COMPLETE', { completed: true });
    }
}

function showActionPanels() {
    // Reset panels
    Object.assign(panelAchoice.style, { display: "flex" });
    Object.assign(panelXinfo.style, { display: "flex", backgroundColor: "white" });
    
    resultText.textContent = "";
    btnYes.disabled = btnNo.disabled = false;

    // Determine if player is forced to press a specific button
    const forcedChoice = Math.random() < gameConfig.pA;
    
    btnNo.style.display = btnYes.style.display = "inline-block";
    
    if (forcedChoice) {
        // Force "Yes"
        btnNo.classList.add("grayed-out");
        btnNo.disabled = true;
        btnYes.classList.remove("grayed-out");
        btnYes.disabled = false;
        document.getElementById("actionPrompt").innerHTML = "You must press \"Yes\" in this round. <br> Press your button? (Use your mouse)";
    } else {
        // Force "No"
        btnNo.classList.remove("grayed-out");
        btnNo.disabled = false;
        btnYes.classList.add("grayed-out");
        btnYes.disabled = true;
        document.getElementById("actionPrompt").innerHTML = "You must press \"No\" in this round. <br> Press your button? (Use your mouse)";
    }
    
    roundStartTime = Date.now();
}

/* ===================== EVENT LISTENERS ===================== */
function handleButtonClick(decision) {
    handleDecision(decision);
}

btnYes.addEventListener("click", () => handleButtonClick('y'));
btnNo.addEventListener("click", () => handleButtonClick('n'));
document.addEventListener("keydown", handleKeyPress);

/* ===================== INITIALIZE GAME ===================== */
setTimeout(() => {
    applyGameConfiguration();
    gameContainer.style.display = "flex";
    sendDataToQualtrics('GAME_START', { started: true });
    nextRound();
}, 2000);

</script>
</body>
</html>