<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confounded Choice</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    @keyframes coinPop {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      50% { transform: translateY(-50px) scale(1.2); opacity: 1; }
      100% { transform: translateY(-70px) scale(0.8); opacity: 0; }
    }
    @keyframes coinSpin {
      0% { transform: scaleX(1); }
      25% { transform: scaleX(0.3); }
      50% { transform: scaleX(1); }
      75% { transform: scaleX(0.3); }
      100% { transform: scaleX(1); }
    }
    @keyframes coinHover {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useCallback, useEffect } = React;

    // Configuration
    const CONFIG = {
      noHeadachePayoff: 2.00,
      headachePayoff: -2.00,
      totalRounds: 100,
      currency: '$',
      
      confounder: {
        pCraving: 0.50,
        pHeadacheGivenCraving: 0.85,
        pHeadacheGivenNoCraving: 0.15,
      },
      
      drinkName: 'Driftwell',
    };

    // Simulate one round
    function simulateRound(craving) {
      const { pHeadacheGivenCraving, pHeadacheGivenNoCraving } = CONFIG.confounder;
      const pHeadache = craving ? pHeadacheGivenCraving : pHeadacheGivenNoCraving;
      const headache = Math.random() < pHeadache;
      return { headache, noHeadache: !headache };
    }

    // Statistics calculator
    function calculateStats(history) {
      const stats = {
        drinkYes: { total: 0, noHeadache: 0 },
        drinkNo: { total: 0, noHeadache: 0 },
        cravingYes: { total: 0, noHeadache: 0, drank: 0 },
        cravingNo: { total: 0, noHeadache: 0, drank: 0 },
      };
      
      history.forEach(round => {
        if (round.drank) {
          stats.drinkYes.total++;
          if (round.noHeadache) stats.drinkYes.noHeadache++;
        } else {
          stats.drinkNo.total++;
          if (round.noHeadache) stats.drinkNo.noHeadache++;
        }
        
        if (round.craving) {
          stats.cravingYes.total++;
          if (round.noHeadache) stats.cravingYes.noHeadache++;
          if (round.drank) stats.cravingYes.drank++;
        } else {
          stats.cravingNo.total++;
          if (round.noHeadache) stats.cravingNo.noHeadache++;
          if (round.drank) stats.cravingNo.drank++;
        }
      });
      
      return stats;
    }

    // Craving indicator
    function CravingIndicator({ craving }) {
      return (
        <div className="flex flex-col items-center">
          <div className="w-12 h-12 rounded-full flex items-center justify-center transition-all duration-500 bg-slate-600">
            <span className={`text-2xl transition-all duration-300 ${craving === null ? 'grayscale opacity-30' : ''}`}>
              {craving === null ? 'â“' : craving ? 'ğŸ¤¤' : 'ğŸ˜'}
            </span>
          </div>
          <div className="text-sm font-medium text-white mt-1">
            {craving === null ? 'Checking...' : craving ? 'Craving!' : 'No Craving'}
          </div>
        </div>
      );
    }

    // Outcome indicator
    function OutcomeIndicator({ noHeadache }) {
      return (
        <div className="flex flex-col items-center">
          <div className={`w-28 h-28 rounded-full flex items-center justify-center transition-all duration-500 ${
            noHeadache === null ? 'bg-slate-700' : noHeadache ? 'bg-gradient-to-br from-emerald-400 to-green-600' : 'bg-gradient-to-br from-rose-400 to-red-600'
          }`}>
            <span className={`text-6xl transition-all duration-300 ${noHeadache === null ? 'grayscale opacity-30' : ''}`}>
              {noHeadache === null ? 'ğŸ¤”' : noHeadache ? 'ğŸ˜Œ' : 'ğŸ¤•'}
            </span>
          </div>
          <div className="text-lg font-bold text-white mt-2">
            {noHeadache === null ? 'Later this day...' : noHeadache ? 'No Headache!' : 'Headache'}
          </div>
          {noHeadache !== null && (
            <div className={`text-lg font-bold mt-1 ${noHeadache ? 'text-green-400' : 'text-red-400'}`}>
              {noHeadache ? '+$2' : '-$2'}
            </div>
          )}
        </div>
      );
    }

    // New Day overlay
    function NewDayOverlay({ show, dayNumber }) {
      if (!show) return null;
      
      return (
        <div className="absolute inset-0 bg-slate-900/95 flex items-center justify-center z-10 rounded-2xl">
          <div className="text-center">
            <div className="text-6xl mb-4">ğŸŒ…</div>
            <div className="text-3xl font-bold text-white">New Day</div>
            <div className="text-xl text-slate-400 mt-2">Day {dayNumber}</div>
          </div>
        </div>
      );
    }

    // Mario-style spinning coin
    function MarioCoin({ show }) {
      if (!show) return null;
      
      return (
        <div className="absolute -top-4 left-1/2 -translate-x-1/2 pointer-events-none">
          <div style={{ animation: 'coinPop 0.8s ease-out forwards' }}>
            <div style={{ animation: 'coinSpin 0.15s linear infinite' }}>
              ğŸª™
            </div>
          </div>
        </div>
      );
    }

    // Static coin hovering above button
    function HoveringCoin({ show, fading }) {
      if (!show) return null;
      
      return (
        <div className={`absolute -top-10 left-1/2 -translate-x-1/2 pointer-events-none transition-opacity duration-500 ${
          fading ? 'opacity-0' : 'opacity-100'
        }`}>
          <div className="text-3xl" style={{ animation: 'coinHover 1s ease-in-out infinite' }}>
            ğŸª™
          </div>
        </div>
      );
    }

    // Drink â†’ Headache correlation
    function DrinkHeadacheCorrelation({ stats, currentDrank }) {
      const drinkHeadacheRate = stats.drinkYes.total > 0 
        ? Math.round(((stats.drinkYes.total - stats.drinkYes.noHeadache) / stats.drinkYes.total) * 100) 
        : null;
      const skipHeadacheRate = stats.drinkNo.total > 0 
        ? Math.round(((stats.drinkNo.total - stats.drinkNo.noHeadache) / stats.drinkNo.total) * 100) 
        : null;
      
      const diff = (drinkHeadacheRate !== null && skipHeadacheRate !== null) 
        ? drinkHeadacheRate - skipHeadacheRate 
        : null;
      
      return (
        <div className="bg-slate-800/50 rounded-lg p-3 border border-blue-500/30">
          <h3 className="text-blue-400 font-bold text-sm mb-2 text-center">
            ğŸ¥¤ Drink â†’ Headache ğŸ¤•
          </h3>
          <div className="flex items-center justify-center gap-4">
            <div className={`text-center px-3 py-1 rounded ${currentDrank === true ? 'bg-blue-800/50 ring-1 ring-blue-400' : ''}`}>
              <div className="text-blue-400 text-xs">Drank</div>
              <div className="text-xl font-bold text-white">
                {drinkHeadacheRate !== null ? `${drinkHeadacheRate}%` : 'â€”'}
              </div>
              <div className="text-xs text-slate-500">n={stats.drinkYes.total}</div>
            </div>
            <div className={`text-center px-3 py-1 rounded ${currentDrank === false ? 'bg-slate-600/50 ring-1 ring-slate-400' : ''}`}>
              <div className="text-slate-400 text-xs">Skipped</div>
              <div className="text-xl font-bold text-white">
                {skipHeadacheRate !== null ? `${skipHeadacheRate}%` : 'â€”'}
              </div>
              <div className="text-xs text-slate-500">n={stats.drinkNo.total}</div>
            </div>
            {diff !== null && (
              <div className="text-center border-l border-slate-600 pl-4">
                <div className="text-slate-400 text-xs">Difference</div>
                <div className={`text-xl font-bold ${diff > 0 ? 'text-red-400' : diff < 0 ? 'text-green-400' : 'text-slate-400'}`}>
                  {diff > 0 ? '+' : ''}{diff}%
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Craving â†’ Headache stats
    function CravingStatsPanel({ stats }) {
      const cravingHeadacheRate = stats.cravingYes.total > 0 
        ? ((stats.cravingYes.total - stats.cravingYes.noHeadache) / stats.cravingYes.total * 100).toFixed(0) 
        : null;
      const noCravingHeadacheRate = stats.cravingNo.total > 0 
        ? ((stats.cravingNo.total - stats.cravingNo.noHeadache) / stats.cravingNo.total * 100).toFixed(0) 
        : null;
        
      return (
        <div className="bg-slate-800/50 rounded-lg p-2 border border-slate-600/20">
          <h3 className="text-slate-400 font-medium text-xs mb-2 text-center">ğŸ¤¤ Craving â†’ Headache</h3>
          <div className="flex justify-center gap-3 text-xs">
            <div className="text-center">
              <div className="text-slate-500">Craving</div>
              <div className="text-lg font-bold text-white">
                {cravingHeadacheRate !== null ? `${cravingHeadacheRate}%` : 'â€”'}
              </div>
            </div>
            <div className="text-slate-600">|</div>
            <div className="text-center">
              <div className="text-slate-500">No Craving</div>
              <div className="text-lg font-bold text-white">
                {noCravingHeadacheRate !== null ? `${noCravingHeadacheRate}%` : 'â€”'}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Drink decision panel
    function DrinkDecisionPanel({ onChoice, disabled, craving, selected, showCoinAnimation, coinFading }) {
      const showHoveringCoin = craving && (selected === null || coinFading) && !showCoinAnimation;
      
      return (
        <div className="flex flex-col items-center">
          <div className="flex justify-center gap-4 relative">
            <div className="relative">
              <HoveringCoin show={showHoveringCoin} fading={coinFading} />
              <MarioCoin show={showCoinAnimation} />
              <button
                onClick={() => onChoice(true)}
                disabled={disabled}
                className={`px-8 py-5 rounded-xl font-bold transition-all flex items-center gap-3 cursor-pointer ${
                  disabled 
                    ? selected === true
                      ? 'bg-red-600 text-white'
                      : 'bg-red-600/40 text-white/50 cursor-not-allowed'
                    : craving
                      ? 'bg-red-600/60 hover:bg-red-600 text-white shadow-lg hover:shadow-xl ring-2 ring-yellow-400'
                      : 'bg-red-600/60 hover:bg-red-600 text-white shadow-lg hover:shadow-xl'
                }`}
              >
                <span className="text-3xl">ğŸ¥¤</span>
                <div className="text-left">
                  <div className="text-lg font-bold">Drink</div>
                  <div className="text-sm opacity-80">{craving ? '+$1' : '+$0'}</div>
                </div>
              </button>
            </div>
            
            <button
              onClick={() => onChoice(false)}
              disabled={disabled}
              className={`px-8 py-5 rounded-xl font-bold transition-all flex items-center gap-3 cursor-pointer ${
                disabled 
                  ? selected === false
                    ? 'bg-green-600 text-white'
                    : 'bg-green-600/40 text-white/50 cursor-not-allowed'
                  : 'bg-green-600/60 hover:bg-green-600 text-white shadow-lg hover:shadow-xl'
              }`}
            >
              <span className="text-3xl">âŠ˜</span>
              <div className="text-left">
                <div className="text-lg font-bold">Skip</div>
                <div className="text-sm opacity-80">+$0</div>
              </div>
            </button>
          </div>
        </div>
      );
    }

    // Scrollable history
    function ScrollableHistory({ history }) {
      const allRounds = history.slice().reverse();
      
      return (
        <div className="bg-slate-800/50 rounded-xl p-3 flex flex-col">
          <h4 className="text-slate-400 text-xs font-medium mb-2">History ({history.length})</h4>
          <div className="flex-1 overflow-y-auto max-h-32 space-y-1 pr-1">
            {allRounds.map((round) => (
              <div key={round.roundNumber} className="flex items-center gap-1 text-xs py-1 px-1.5 bg-slate-700/30 rounded">
                <span className="text-slate-500 w-5">#{round.roundNumber}</span>
                <span className={`w-5 ${round.craving ? 'text-purple-400' : 'text-slate-500'}`}>
                  {round.craving ? 'ğŸ¤¤' : 'ğŸ˜'}
                </span>
                <span className={`w-6 h-6 flex items-center justify-center rounded ${round.drank ? 'bg-red-600' : 'bg-green-600'}`}>
                  {round.drank ? 'ğŸ¥¤' : 'âŠ˜'}
                </span>
                <span className={`w-6 h-6 flex items-center justify-center rounded text-base ${round.noHeadache ? 'bg-green-600' : 'bg-red-600'}`}>
                  {round.noHeadache ? 'ğŸ˜Œ' : 'ğŸ¤•'}
                </span>
                <span className={`flex-1 text-right font-medium ${round.earnings >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                  {round.earnings >= 0 ? '+' : ''}{CONFIG.currency}{round.earnings.toFixed(2)}
                </span>
              </div>
            ))}
            {history.length === 0 && (
              <p className="text-slate-500 text-center py-2 text-xs">No days yet</p>
            )}
          </div>
        </div>
      );
    }

    // Main experiment component
    function CravingExperiment() {
      const [currentRound, setCurrentRound] = useState(1);
      const [phase, setPhase] = useState('craving');
      const [history, setHistory] = useState([]);
      const [currentCraving, setCurrentCraving] = useState(null);
      const [currentDrank, setCurrentDrank] = useState(null);
      const [currentOutcome, setCurrentOutcome] = useState(null);
      const [showCoinAnimation, setShowCoinAnimation] = useState(false);
      const [coinFading, setCoinFading] = useState(false);
      const [showNewDay, setShowNewDay] = useState(false);
      const [nextDayNumber, setNextDayNumber] = useState(2);
      const [totalEarnings, setTotalEarnings] = useState(0);
      const [selectedPaymentRound, setSelectedPaymentRound] = useState(null);
      
      const stats = calculateStats(history);
      
      const startRound = useCallback(() => {
        const craving = Math.random() < CONFIG.confounder.pCraving;
        setCurrentCraving(craving);
        setPhase('decision');
      }, []);
      
      useEffect(() => {
        if (phase === 'craving' && currentCraving === null) {
          setTimeout(startRound, 500);
        }
      }, [phase, currentCraving, startRound]);
      
      const handleChoice = useCallback((drank) => {
        setCurrentDrank(drank);
        
        if (currentCraving) {
          if (drank) {
            setShowCoinAnimation(true);
            setTimeout(() => setShowCoinAnimation(false), 800);
          } else {
            setCoinFading(true);
            setTimeout(() => setCoinFading(false), 500);
          }
        }
        
        setPhase('outcome');
        
        const result = simulateRound(currentCraving);
        
        setTimeout(() => {
          setCurrentOutcome(result.noHeadache);
          
          const earnings = result.noHeadache ? CONFIG.noHeadachePayoff : CONFIG.headachePayoff;
          
          const roundData = {
            roundNumber: currentRound,
            craving: currentCraving,
            drank: drank,
            noHeadache: result.noHeadache,
            earnings: earnings,
          };
          
          setHistory(prev => [...prev, roundData]);
          setTotalEarnings(prev => prev + earnings);
          
          if (currentRound >= CONFIG.totalRounds) {
            setTimeout(() => {
              const paymentRound = Math.floor(Math.random() * CONFIG.totalRounds) + 1;
              setSelectedPaymentRound(paymentRound);
              setPhase('complete');
            }, 2000);
          } else {
            setTimeout(() => {
              setNextDayNumber(currentRound + 1);
              setShowNewDay(true);
              
              setTimeout(() => {
                setShowNewDay(false);
                setCurrentRound(prev => prev + 1);
                setPhase('craving');
                setCurrentCraving(null);
                setCurrentDrank(null);
                setCurrentOutcome(null);
                setCoinFading(false);
                setTimeout(startRound, 300);
              }, 1000);
            }, 1500);
          }
        }, 800);
      }, [currentRound, currentCraving, startRound]);
      
      // Complete screen
      if (phase === 'complete') {
        const paymentRoundData = history[selectedPaymentRound - 1];
        const drinkHeadacheRate = stats.drinkYes.total > 0 
          ? Math.round((stats.drinkYes.total - stats.drinkYes.noHeadache) / stats.drinkYes.total * 100) 
          : 0;
        const skipHeadacheRate = stats.drinkNo.total > 0 
          ? Math.round((stats.drinkNo.total - stats.drinkNo.noHeadache) / stats.drinkNo.total * 100) 
          : 0;
        const cravingHeadacheRate = stats.cravingYes.total > 0 
          ? Math.round((stats.cravingYes.total - stats.cravingYes.noHeadache) / stats.cravingYes.total * 100) 
          : 0;
        const noCravingHeadacheRate = stats.cravingNo.total > 0 
          ? Math.round((stats.cravingNo.total - stats.cravingNo.noHeadache) / stats.cravingNo.total * 100) 
          : 0;
          
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-xl w-full">
              <div className="text-center">
                <div className="text-6xl mb-4">ğŸ‰</div>
                <h1 className="text-3xl font-bold text-gray-800 mb-2">Experiment Complete!</h1>
                <p className="text-gray-600 mb-6">All {CONFIG.totalRounds} rounds finished.</p>
              </div>
              
              <div className="bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl p-5 text-white mb-4">
                <h3 className="font-bold mb-3 text-lg">ğŸ¥¤ Drink â†’ Headache</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-white/20 rounded-lg p-3">
                    <div className="text-sm">Drank</div>
                    <div className="text-3xl font-bold">{drinkHeadacheRate}%</div>
                    <div className="text-xs opacity-80">headache</div>
                  </div>
                  <div className="bg-white/20 rounded-lg p-3">
                    <div className="text-sm">Skipped</div>
                    <div className="text-3xl font-bold">{skipHeadacheRate}%</div>
                    <div className="text-xs opacity-80">headache</div>
                  </div>
                </div>
                <div className="mt-3 text-center text-sm">
                  Difference: <span className="font-bold text-lg">{drinkHeadacheRate - skipHeadacheRate > 0 ? '+' : ''}{drinkHeadacheRate - skipHeadacheRate}%</span>
                </div>
              </div>
              
              <div className="bg-gray-100 rounded-lg p-3 mb-4">
                <h3 className="font-medium mb-2 text-gray-600 text-sm">ğŸ¤¤ Craving â†’ Headache</h3>
                <div className="flex justify-center gap-6 text-sm">
                  <div className="text-center">
                    <div className="text-gray-500">Craving</div>
                    <div className="text-xl font-bold text-gray-800">{cravingHeadacheRate}%</div>
                  </div>
                  <div className="text-center">
                    <div className="text-gray-500">No Craving</div>
                    <div className="text-xl font-bold text-gray-800">{noCravingHeadacheRate}%</div>
                  </div>
                </div>
              </div>
              
              <div className="bg-emerald-50 border-2 border-emerald-200 rounded-xl p-5">
                <p className="text-sm text-emerald-600 mb-1">Payment Round #{selectedPaymentRound}</p>
                <div className="text-sm text-emerald-700 mb-2">
                  {paymentRoundData.craving ? 'ğŸ¤¤ Craving' : 'ğŸ˜ No Craving'} â†’ 
                  {paymentRoundData.drank ? ' ğŸ¥¤ Drank' : ' âŠ˜ Skipped'} â†’ 
                  {paymentRoundData.noHeadache ? ' ğŸ˜Œ No Headache' : ' ğŸ¤• Headache'}
                </div>
                <p className="text-3xl font-bold text-emerald-800">
                  {paymentRoundData.earnings >= 0 ? '+' : ''}{CONFIG.currency}{paymentRoundData.earnings.toFixed(2)}
                </p>
              </div>
            </div>
          </div>
        );
      }
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
          <div className="max-w-5xl mx-auto">
            <div className="flex items-center justify-between mb-4">
              <div className="bg-white/10 backdrop-blur rounded-xl px-4 py-2">
                <div className="flex items-center gap-3">
                  <div>
                    <span className="text-white/60 text-xs">Day</span>
                    <div className="text-white text-2xl font-bold">{currentRound}<span className="text-white/40 text-lg">/{CONFIG.totalRounds}</span></div>
                  </div>
                  <div className="w-24 h-2 bg-white/20 rounded-full overflow-hidden">
                    <div 
                      className="h-full bg-gradient-to-r from-blue-400 to-purple-500 transition-all duration-300"
                      style={{ width: `${(currentRound / CONFIG.totalRounds) * 100}%` }}
                    />
                  </div>
                </div>
              </div>
            </div>
            
            <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 mb-4 border border-slate-700 relative overflow-hidden">
              <NewDayOverlay show={showNewDay} dayNumber={nextDayNumber} />
              
              <div className="flex items-center justify-center gap-8">
                <CravingIndicator craving={currentCraving} />
                <div className="text-slate-500 text-2xl">â†’</div>
                <DrinkDecisionPanel 
                  onChoice={handleChoice} 
                  disabled={phase !== 'decision'}
                  craving={currentCraving}
                  selected={currentDrank}
                  showCoinAnimation={showCoinAnimation}
                  coinFading={coinFading}
                />
                <div className="text-slate-500 text-2xl">â†’</div>
                <OutcomeIndicator noHeadache={currentOutcome} />
              </div>
              
              <div className="text-center mt-4">
                <span className={`inline-block px-4 py-2 rounded-full text-sm font-medium ${
                  phase === 'craving' ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30' :
                  phase === 'decision' ? 'bg-blue-500/20 text-blue-300 border border-blue-500/30' :
                  'bg-green-500/20 text-green-300 border border-green-500/30'
                }`}>
                  {phase === 'craving' && 'Morning: Checking how you feel...'}
                  {phase === 'decision' && (currentCraving ? 'ğŸ¤¤ Craving!' : 'ğŸ˜ No craving today')}
                  {phase === 'outcome' && `Later this day: ${currentOutcome ? 'No headache! ğŸ˜Œ' : 'Headache ğŸ¤•'}`}
                </span>
              </div>
            </div>
            
            <div className="grid grid-cols-3 gap-3 mt-4">
              <CravingStatsPanel stats={stats} />
              <DrinkHeadacheCorrelation stats={stats} currentDrank={currentDrank} />
              <ScrollableHistory history={history} />
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(<CravingExperiment />);
  </script>
</body>
</html>
