<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dieter's Dilemma</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }

    /* Hide slider thumb when confidence not yet selected */
    .slider-hidden-thumb::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      opacity: 0;
    }
    .slider-hidden-thumb::-moz-range-thumb {
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // =============== QUALTRICS COMMUNICATION ===============
    let participantId = null;
    let gameId = null;
    
    // Receive config from Qualtrics
    window.addEventListener('message', function(event) {
      if (event.data.type === 'INIT') {
        console.log('Received INIT from Qualtrics:', event.data);
        participantId = event.data.participantId;
        gameId = event.data.gameId;
        
        if (event.data.gameConfig) {
          const qConfig = event.data.gameConfig;
          if (qConfig.nRounds) CONFIG.totalRounds = qConfig.nRounds;
          if (qConfig.id) CONFIG.id = qConfig.id;
          if (qConfig.yBonus !== undefined) CONFIG.yBonus = qConfig.yBonus;
          if (qConfig.aCost !== undefined) CONFIG.aCost = qConfig.aCost;
          if (qConfig.pY !== undefined) CONFIG.pY = qConfig.pY;
          if (qConfig.playerName0) CONFIG.playerName0 = qConfig.playerName0;
          if (qConfig.playerName1) CONFIG.playerName1 = qConfig.playerName1;
          if (qConfig.playerName2) CONFIG.playerName2 = qConfig.playerName2;
          if (qConfig.playerIcon0) CONFIG.playerIcon0 = qConfig.playerIcon0;
          if (qConfig.currentSymbol) CONFIG.currentSymbol = qConfig.currentSymbol;
          if (qConfig.causal !== undefined) CONFIG.causal = qConfig.causal;
          // Collider parameters (causal=0)
          if (qConfig.beta00 !== undefined) CONFIG.beta00 = qConfig.beta00;
          if (qConfig.beta01 !== undefined) CONFIG.beta01 = qConfig.beta01;
          if (qConfig.beta10 !== undefined) CONFIG.beta10 = qConfig.beta10;
          if (qConfig.beta11 !== undefined) CONFIG.beta11 = qConfig.beta11;
          // Causal parameters (causal=1)
          if (qConfig.sigma0 !== undefined) CONFIG.sigma0 = qConfig.sigma0;
          if (qConfig.sigma1 !== undefined) CONFIG.sigma1 = qConfig.sigma1;
          if (qConfig.rho0 !== undefined) CONFIG.rho0 = qConfig.rho0;
          if (qConfig.rho1 !== undefined) CONFIG.rho1 = qConfig.rho1;
          console.log('Applied config:', CONFIG);
        }
        
        // Mark as initialized and trigger callbacks
        markInitialized();
        
        sendDataToQualtrics('GAME_START', { started: true });
      }
    });
    
    // Send data to Qualtrics
    function sendDataToQualtrics(dataType, data) {
      if (window.parent !== window) {
        window.parent.postMessage({
          type: 'GAME_DATA',
          gameId: gameId,
          dataType: dataType,
          data: data,
          participantId: participantId,
          timestamp: new Date().toISOString()
        }, '*');
      }
      console.log('Sent to Qualtrics:', dataType, data);
    }
    
    // Configuration (matches Qualtrics embedded data names)
    // A = drink decision (1=drink, 0=skip)
    // X = chemical level (1=normal, 0=abnormal)  
    // Y = feeling (1=energetic, 0=tired)
    const CONFIG = {
      yBonus: 2.00,           // Bonus when Y=1 (energetic)
      aCost: 0.00,            // Cost of drinking (A=1)
      totalRounds: 10,
      currency: '$',
      id: 1,
      
      // DGP parameters
      causal: 0,              // 0 = collider, 1 = causal chain
      pY: 0.50,               // P(Y=1) base probability (used when causal=0)
      
      // Collider parameters (causal=0): P(X=1) = beta[A*2 + Y]
      beta00: 0.05,           // P(X=1 | A=0, Y=0)
      beta01: 0.80,           // P(X=1 | A=0, Y=1)
      beta10: 0.80,           // P(X=1 | A=1, Y=0)
      beta11: 0.95,           // P(X=1 | A=1, Y=1)
      
      // Causal chain parameters (causal=1)
      sigma0: 0.20,           // P(X=1 | A=0)
      sigma1: 0.80,           // P(X=1 | A=1)
      rho0: 0.20,             // P(Y=1 | X=0)
      rho1: 0.80,             // P(Y=1 | X=1)
      
      playerName0: 'Driftwell', // Drink name (A)
      playerName1: 'Qivaryn',   // Chemical name (X)
      playerName2: 'Feeling',   // Outcome name (Y)
      playerIcon0: 'ü•§',        // Icon for drink action (A)
      currentSymbol: null,      // HTML for scenario tile display
    };
  </script>
  
  <script type="text/babel">
    const { useState, useCallback, useRef, useEffect } = React;
    
    // Track if config has been received from Qualtrics
    let isInitialized = false;
    let initCallbacks = [];
    
    function onInitialized(callback) {
      if (isInitialized) {
        callback();
      } else {
        initCallbacks.push(callback);
      }
    }
    
    function markInitialized() {
      isInitialized = true;
      initCallbacks.forEach(cb => cb());
      initCallbacks = [];
    }

    // Simulate one round based on DGP
    // A = drink (1/0), X = chemical normal (1/0), Y = feel good (1/0)
    function simulateRound(A) {
      let X, Y;
      
      if (CONFIG.causal === 0) {
        // Collider: Y is independent, X depends on both A and Y
        const pX = [CONFIG.beta00, CONFIG.beta01, CONFIG.beta10, CONFIG.beta11];
        Y = Math.random() < CONFIG.pY ? 1 : 0;
        X = Math.random() < pX[A * 2 + Y] ? 1 : 0;
      } else {
        // Causal chain: A -> X -> Y
        const pX = [CONFIG.sigma0, CONFIG.sigma1];
        const pY = [CONFIG.rho0, CONFIG.rho1];
        X = Math.random() < pX[A] ? 1 : 0;
        Y = Math.random() < pY[X] ? 1 : 0;
      }
      
      return { A, X, Y };
    }

    // Statistics calculator
    // history format: [[A, X, Y], [A, X, Y], ...]
    function calculateStats(history) {
      const stats = {
        A1: { total: 0, X1: 0, Y1: 0 },  // When A=1 (drank)
        A0: { total: 0, X1: 0, Y1: 0 },  // When A=0 (skipped)
        X1: { total: 0, Y1: 0 },          // When X=1 (normal)
        X0: { total: 0, Y1: 0 },          // When X=0 (abnormal)
      };
      
      history.forEach(round => {
        const [A, X, Y] = round;
        
        if (A === 1) {
          stats.A1.total++;
          if (X === 1) stats.A1.X1++;
          if (Y === 1) stats.A1.Y1++;
        } else {
          stats.A0.total++;
          if (X === 1) stats.A0.X1++;
          if (Y === 1) stats.A0.Y1++;
        }
        
        if (X === 1) {
          stats.X1.total++;
          if (Y === 1) stats.X1.Y1++;
        } else {
          stats.X0.total++;
          if (Y === 1) stats.X0.Y1++;
        }
      });
      
      return stats;
    }

    // New Day overlay
    function NewDayOverlay({ show, dayNumber }) {
      if (!show) return null;
      
      return (
        <div className="absolute inset-0 bg-slate-900 flex items-center justify-center z-20 rounded-2xl">
          <div className="text-center">
            <div className="text-6xl mb-4">üåÖ</div>
            <div className="text-3xl font-bold text-white">New Week</div>
            <div className="text-xl text-slate-400 mt-2">Monday, Week {dayNumber}</div>
          </div>
        </div>
      );
    }

    // BioClip device (shows X = chemical level)
    function BioClipLarge({ status }) {
      const getStatusColor = () => {
        if (status === null) return '#64748b';
        return status === 1 ? '#22c55e' : '#ef4444';
      };
      
      const getStatusBg = () => {
        if (status === null) return '#1e293b';
        return status === 1 ? '#14532d' : '#7f1d1d';
      };
      
      return (
        <div className="flex flex-col items-center">
          <svg viewBox="0 0 120 160" className="w-32 h-44">
            <rect x="10" y="10" width="100" height="140" rx="12" fill="#0f172a" stroke="#334155" strokeWidth="2" />
            <rect x="18" y="20" width="84" height="100" rx="6" fill="#1e293b" />
            <rect x="22" y="24" width="76" height="92" rx="4" fill={getStatusBg()} className="transition-all duration-500" />
            <circle cx="60" cy="55" r="24" fill={getStatusColor()} className="transition-all duration-300">
              {status !== null && (
                <animate attributeName="r" values="24;28;24" dur="0.5s" repeatCount="1" />
              )}
            </circle>
            {status === 1 && (
              <path d="M48 55 L56 63 L72 47" stroke="white" strokeWidth="4" fill="none" strokeLinecap="round" strokeLinejoin="round">
                <animate attributeName="stroke-dasharray" values="0,100;100,0" dur="0.3s" fill="freeze" />
              </path>
            )}
            {status === 0 && (
              <g stroke="white" strokeWidth="4" strokeLinecap="round">
                <line x1="50" y1="45" x2="70" y2="65">
                  <animate attributeName="stroke-dasharray" values="0,100;100,0" dur="0.2s" fill="freeze" />
                </line>
                <line x1="70" y1="45" x2="50" y2="65">
                  <animate attributeName="stroke-dasharray" values="0,100;100,0" dur="0.2s" fill="freeze" />
                </line>
              </g>
            )}
            <text x="60" y="100" textAnchor="middle" fill={status === null ? '#64748b' : 'white'} fontSize="11" fontWeight="bold">
              {status === null ? 'READING...' : status === 1 ? 'NORMAL' : 'ABNORMAL'}
            </text>
            <rect x="30" y="126" width="60" height="18" rx="4" fill="#334155" />
            <text x="60" y="139" textAnchor="middle" fill="#94a3b8" fontSize="10" fontFamily="monospace">
              BioClip‚Ñ¢
            </text>
            <path d="M0 50 L10 50 L10 110 L0 110 C-4 110 -6 105 -6 100 L-6 60 C-6 55 -4 50 0 50 Z" fill="#475569" />
          </svg>
          <div className="text-lg font-bold text-white mt-2">{CONFIG.playerName1} Level</div>
        </div>
      );
    }

    // Mood indicator (shows Y = feeling)
    function MoodLarge({ mood }) {
      return (
        <div className="flex flex-col items-center mt-12">
          <div className={`w-32 h-32 rounded-full flex items-center justify-center transition-all duration-500 ${
            mood === null ? 'bg-slate-700' : mood === 1 ? 'bg-gradient-to-br from-emerald-400 to-green-600' : 'bg-gradient-to-br from-rose-400 to-red-600'
          }`}>
            <span className={`text-7xl transition-all duration-300 ${mood === null ? 'grayscale opacity-30' : ''}`}>
              {mood === null ? 'üòê' : mood === 1 ? 'üòä' : 'üòî'}
            </span>
          </div>
          <div className="text-lg font-bold text-white mt-3">
            {mood === null ? 'Later this day...' : mood === 1 ? 'Energetic!' : 'Tired'}
          </div>
          <div className={`text-lg font-bold mt-1 ${mood === null ? 'invisible' : mood === 1 ? 'text-green-400' : 'text-red-400'}`}>
            {mood === null ? '\u00A0' : mood === 1 ? `+${CONFIG.currency}${CONFIG.yBonus}` : `${CONFIG.currency}0`}
          </div>
        </div>
      );
    }

    // Connection between X (chemical) and Y (feeling)
    function XYConnection({ X, Y, stats, hideRateBox }) {
      const X1Y1Rate = stats.X1.total > 0 
        ? Math.round((stats.X1.Y1 / stats.X1.total) * 100) 
        : null;
      const X0Y1Rate = stats.X0.total > 0 
        ? Math.round((stats.X0.Y1 / stats.X0.total) * 100) 
        : null;
      
      const showConnection = X !== null;
      const connectionColor = X === 1 ? '#22c55e' : '#ef4444';
      
      return (
        <div className="relative flex items-center justify-center gap-8 py-8">
          <BioClipLarge status={X} />
          
          <div className="flex flex-col items-center relative">
            <svg width="180" height="80" className="absolute top-1/2 -translate-y-1/2">
              <line x1="0" y1="40" x2="180" y2="40" stroke="#334155" strokeWidth="4" strokeDasharray="8,4" />
              {showConnection && (
                <>
                  <line 
                    x1="0" y1="40" x2="180" y2="40" 
                    stroke={connectionColor} 
                    strokeWidth="6" 
                    strokeLinecap="round"
                    opacity="0.5"
                  >
                    <animate attributeName="stroke-dashoffset" values="0;-24" dur="0.5s" repeatCount="indefinite" />
                    <animate attributeName="stroke-dasharray" values="12,12" dur="0.5s" />
                  </line>
                  <circle r="8" fill={connectionColor}>
                    <animate attributeName="cx" values="10;170" dur="0.8s" fill="freeze" />
                    <animate attributeName="cy" values="40;40" dur="0.8s" />
                    <animate attributeName="opacity" values="1;0" dur="0.8s" fill="freeze" />
                  </circle>
                </>
              )}
              <polygon points="170,40 155,30 155,50" fill={showConnection ? connectionColor : '#334155'} className="transition-all duration-300" />
            </svg>
            
            {!hideRateBox && (
              <div className={`bg-slate-800 border-2 rounded-xl px-4 py-3 z-10 transition-all duration-300 ${
                showConnection ? (X === 1 ? 'border-green-500' : 'border-red-500') : 'border-slate-600'
              }`}>
                <div className="text-xs text-slate-400 text-center mb-1">
                  {X === null ? 'Historical Rate' : X === 1 ? 'When NORMAL' : 'When ABNORMAL'}
                </div>
                <div className="text-3xl font-bold text-center text-white">
                  {X === null ? (
                    <span className="text-slate-500">‚Äî</span>
                  ) : X === 1 ? (
                    X1Y1Rate !== null ? `${X1Y1Rate}%` : '‚Äî'
                  ) : (
                    X0Y1Rate !== null ? `${X0Y1Rate}%` : '‚Äî'
                  )}
                </div>
                <div className="text-xs text-slate-400 text-center">
                  energetic
                </div>
              </div>
            )}
          </div>
          
          <MoodLarge mood={Y} />
        </div>
      );
    }

    // X Statistics Panel (X ‚Üí Y relationship)
    function XStatsPanel({ stats, currentX }) {
      const X1Y1Rate = stats.X1.total > 0 
        ? (stats.X1.Y1 / stats.X1.total * 100).toFixed(0) 
        : null;
      const X0Y1Rate = stats.X0.total > 0 
        ? (stats.X0.Y1 / stats.X0.total * 100).toFixed(0) 
        : null;
        
      return (
        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 border-2 border-cyan-500/30">
          <h3 className="text-cyan-400 font-bold text-lg mb-4 flex items-center gap-2">
            <span className="text-2xl">üìä</span> {CONFIG.playerName1} ‚Üí Energetic
          </h3>
          
          <div className="grid grid-cols-2 gap-4">
            <div className={`rounded-xl p-4 transition-all duration-300 ${
              currentX === 1 ? 'bg-green-900/50 ring-2 ring-green-400' : 'bg-slate-700/50'
            }`}>
              <div className="flex items-center gap-2 mb-2">
                <div className="w-4 h-4 rounded-full bg-green-500" />
                <span className="text-green-400 font-medium">Normal</span>
              </div>
              <div className="text-4xl font-bold text-white mb-1">
                {X1Y1Rate !== null ? `${X1Y1Rate}%` : '‚Äî'}
              </div>
              <div className="text-sm text-slate-400">
                energetic ({stats.X1.Y1}/{stats.X1.total})
              </div>
              <div className="mt-3 h-3 bg-slate-600 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all duration-500"
                  style={{ width: X1Y1Rate ? `${X1Y1Rate}%` : '0%' }}
                />
              </div>
            </div>
            
            <div className={`rounded-xl p-4 transition-all duration-300 ${
              currentX === 0 ? 'bg-red-900/50 ring-2 ring-red-400' : 'bg-slate-700/50'
            }`}>
              <div className="flex items-center gap-2 mb-2">
                <div className="w-4 h-4 rounded-full bg-red-500" />
                <span className="text-red-400 font-medium">Abnormal</span>
              </div>
              <div className="text-4xl font-bold text-white mb-1">
                {X0Y1Rate !== null ? `${X0Y1Rate}%` : '‚Äî'}
              </div>
              <div className="text-sm text-slate-400">
                energetic ({stats.X0.Y1}/{stats.X0.total})
              </div>
              <div className="mt-3 h-3 bg-slate-600 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-red-500 to-rose-400 transition-all duration-500"
                  style={{ width: X0Y1Rate ? `${X0Y1Rate}%` : '0%' }}
                />
              </div>
            </div>
          </div>
          
          {X1Y1Rate !== null && X0Y1Rate !== null && (
            <div className="mt-4 bg-cyan-900/30 rounded-lg p-3 border border-cyan-500/30">
              <div className="text-center">
                <span className="text-cyan-400 text-sm">Difference: </span>
                <span className="text-white font-bold text-xl">
                  {X1Y1Rate - X0Y1Rate > 0 ? '+' : ''}{X1Y1Rate - X0Y1Rate}%
                </span>
                <span className="text-slate-400 text-sm"> more likely to be energetic when {CONFIG.playerName1} is normal</span>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Drink decision panel (A = action)
    function DrinkDecisionPanel({ onChoice, disabled, stats }) {
      const A1Y1Rate = stats.A1.total > 0 
        ? Math.round(stats.A1.Y1 / stats.A1.total * 100) 
        : null;
      const A0Y1Rate = stats.A0.total > 0 
        ? Math.round(stats.A0.Y1 / stats.A0.total * 100) 
        : null;
        
      return (
        <div className="bg-slate-800/50 rounded-xl p-4">
          <h4 className="text-slate-400 text-sm font-medium mb-3 text-center">Morning Decision</h4>
          <div className="flex justify-center gap-3">
            <button
              onClick={() => onChoice(1)}
              disabled={disabled}
              className={`w-32 h-20 px-4 py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${
                disabled
                  ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                  : 'bg-green-600 hover:bg-green-500 text-white shadow-lg hover:shadow-xl cursor-pointer'
              }`}
            >
              <span className="text-xl">{CONFIG.playerIcon0}</span>
              <div className="text-left">
                <div>Drink</div>
                <div>{CONFIG.playerName0}</div>
                <div className="text-xs opacity-70">-{CONFIG.currency}{CONFIG.aCost}</div>
              </div>
            </button>
            <button
              onClick={() => onChoice(0)}
              disabled={disabled}
              className={`w-32 h-20 px-4 py-3 rounded-lg font-bold transition-all flex flex-col items-center justify-center ${
                disabled
                  ? 'bg-slate-700 text-slate-500 cursor-not-allowed'
                  : 'bg-red-600 hover:bg-red-500 text-white shadow-lg hover:shadow-xl cursor-pointer'
              }`}
            >
              <div className="flex items-center gap-2">
                <span className="text-xl">‚äò</span>
                <span>Skip</span>
              </div>
              <div className="text-xs opacity-70">{CONFIG.currency}0</div>
            </button>
          </div>
          
          <div className="mt-3 space-y-2">
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className="bg-slate-700/50 rounded p-2 text-center">
                <div className="text-green-400">{CONFIG.playerName0} ‚Üí {CONFIG.playerName1}</div>
                <div className="text-white font-bold">
                  {stats.A1.total > 0
                    ? `${Math.round(stats.A1.X1 / stats.A1.total * 100)}% normal`
                    : '‚Äî'}
                </div>
              </div>
              <div className="bg-slate-700/50 rounded p-2 text-center">
                <div className="text-red-400">Skip ‚Üí {CONFIG.playerName1}</div>
                <div className="text-white font-bold">
                  {stats.A0.total > 0 
                    ? `${Math.round(stats.A0.X1 / stats.A0.total * 100)}% normal`
                    : '‚Äî'}
                </div>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className="bg-slate-700/50 rounded p-2 text-center">
                <div className="text-green-400">{CONFIG.playerName0} ‚Üí Energetic</div>
                <div className="text-white font-bold">
                  {A1Y1Rate !== null ? `${A1Y1Rate}%` : '‚Äî'}
                </div>
              </div>
              <div className="bg-slate-700/50 rounded p-2 text-center">
                <div className="text-red-400">Skip ‚Üí Energetic</div>
                <div className="text-white font-bold">
                  {A0Y1Rate !== null ? `${A0Y1Rate}%` : '‚Äî'}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // DAG Iframe Component
    function DAGIframe({ onComplete, playerName0, playerName1, playerIcon0 }) {
      const iframeRef = useRef(null);

      useEffect(() => {
        const handleMessage = (event) => {
          if (event.data.type === 'DAG_DATA' && event.data.dataType === 'DAG_COMPLETE') {
            const data = event.data.data;
            onComplete(data.initialDAG, data.finalDAG, data.confidence);
          }
        };

        window.addEventListener('message', handleMessage);

        // Send INIT to iframe once loaded
        const sendInit = () => {
          if (iframeRef.current && iframeRef.current.contentWindow) {
            iframeRef.current.contentWindow.postMessage({
              type: 'INIT',
              gameConfig: {
                playerName0: playerName0,
                playerName1: playerName1,
                playerIcon0: playerIcon0
              }
            }, '*');
          }
        };

        // Try sending after a short delay to ensure iframe is loaded
        const timeout = setTimeout(sendInit, 500);

        return () => {
          window.removeEventListener('message', handleMessage);
          clearTimeout(timeout);
        };
      }, [onComplete, playerName0, playerName1, playerIcon0]);

      return (
        <iframe
          ref={iframeRef}
          src="dagElicitation.html"
          style={{ width: '100%', height: '100vh', border: 'none' }}
          onLoad={() => {
            if (iframeRef.current && iframeRef.current.contentWindow) {
              iframeRef.current.contentWindow.postMessage({
                type: 'INIT',
                gameConfig: {
                  playerName0: playerName0,
                  playerName1: playerName1,
                  playerIcon0: playerIcon0
                }
              }, '*');
            }
          }}
        />
      );
    }

    // Recent history - displays [[A, X, Y], ...]
    function CompactHistory({ history }) {
      const recentRounds = history.slice().reverse().slice(0, 8);
      
      return (
        <div className="bg-slate-800/50 rounded-xl p-4">
          <h4 className="text-slate-400 text-sm font-medium mb-3">All Weeks</h4>
          <div className="space-y-1">
            {recentRounds.map((round, idx) => {
              const [A, X, Y] = round;
              const roundNumber = history.length - idx;
              return (
                <div key={roundNumber} className="flex items-center gap-2 text-sm py-1 px-2 bg-slate-700/30 rounded">
                  <span className="text-slate-500 w-6">#{roundNumber}</span>
                  <span className={`w-12 ${A === 1 ? 'text-blue-400' : 'text-slate-500'}`}>
                    {A === 1 ? CONFIG.playerIcon0 : '‚äò'}
                  </span>
                  <span className={`flex-1 font-medium ${X === 1 ? 'text-green-400' : 'text-red-400'}`}>
                    {X === 1 ? 'Normal' : 'Abnormal'}
                  </span>
                  <span className={`text-2xl w-10 h-10 flex items-center justify-center rounded-lg ${
                    Y === 1 ? 'bg-green-600' : 'bg-red-600'
                  }`}>
                    {Y === 1 ? 'üòä' : 'üòî'}
                  </span>
                </div>
              );
            })}
            {history.length === 0 && (
              <p className="text-slate-500 text-center py-4">No days yet</p>
            )}
          </div>
        </div>
      );
    }

    // Main experiment component
    function BeverageExperiment() {
      const [ready, setReady] = useState(false);
      const [currentRound, setCurrentRound] = useState(1);
      const [phase, setPhase] = useState('decision');
      const [history, setHistory] = useState([]);  // [[A, X, Y], ...]
      const [currentA, setCurrentA] = useState(null);
      const [currentX, setCurrentX] = useState(null);
      const [currentY, setCurrentY] = useState(null);
      const [showNewDay, setShowNewDay] = useState(false);
      const [nextDayNumber, setNextDayNumber] = useState(2);
      const [totalEarnings, setTotalEarnings] = useState(0);
      const [selectedPaymentRound, setSelectedPaymentRound] = useState(null);
      
      // DAG-related state
      const [showDAG, setShowDAG] = useState(false);
      const [dagCompleted, setDagCompleted] = useState(false);
      const [dagData, setDagData] = useState({ initial: null, final: null });
      const [hideRateBox, setHideRateBox] = useState(false);
      
      const roundTimesRef = useRef([]);
      const roundStartTimeRef = useRef(Date.now());
      const dataSentRef = useRef(false);
      const halfwayDAGShownRef = useRef(false);
      
      // Wait for Qualtrics config before showing game (max 3 seconds)
      useEffect(() => {
        const timeout = setTimeout(() => {
          if (!ready) {
            console.log('Timeout: starting with default config');
            setReady(true);
            roundStartTimeRef.current = Date.now();
          }
        }, 3000);
        
        onInitialized(() => {
          clearTimeout(timeout);
          setReady(true);
          roundStartTimeRef.current = Date.now();
        });
        
        return () => clearTimeout(timeout);
      }, []);
      
      const stats = calculateStats(history);
      
      const handleChoice = useCallback((A) => {
        roundTimesRef.current.push((Date.now() - roundStartTimeRef.current) / 1000);
        
        setCurrentA(A);
        setPhase('chemical');
        
        const result = simulateRound(A);
        
        setTimeout(() => {
          setCurrentX(result.X);
          
          setTimeout(() => {
            setPhase('outcome');
            setCurrentY(result.Y);
            
            // earnings = -aCost*A + yBonus*Y
            const earnings = -CONFIG.aCost * A + CONFIG.yBonus * result.Y;
            
            // Store as [A, X, Y]
            setHistory(prev => [...prev, [A, result.X, result.Y]]);
            setTotalEarnings(prev => prev + earnings);
            
            if (currentRound >= CONFIG.totalRounds) {
              setTimeout(() => {
                const paymentRound = Math.floor(Math.random() * CONFIG.totalRounds) + 1;
                setSelectedPaymentRound(paymentRound);
                setPhase('complete');
              }, 2000);
            } else {
              // Check if we're at the halfway point and haven't shown DAG yet
              const halfwayPoint = Math.floor(CONFIG.totalRounds / 2);
              if (currentRound === halfwayPoint && !halfwayDAGShownRef.current) {
                halfwayDAGShownRef.current = true;
                setTimeout(() => {
                  setShowDAG(true);
                }, 1500);
              } else {
                setTimeout(() => {
                  // Show overlay immediately, reset values while overlay is visible
                  setNextDayNumber(currentRound + 1);
                  setShowNewDay(true);

                  // Reset values while overlay is covering (users won't see the change)
                  setTimeout(() => {
                    setCurrentA(null);
                    setCurrentX(null);
                    setCurrentY(null);
                  }, 200);

                  // Hide overlay and advance to next round
                  setTimeout(() => {
                    setShowNewDay(false);
                    setCurrentRound(prev => prev + 1);
                    setPhase('decision');
                    roundStartTimeRef.current = Date.now();
                  }, 1200);
                }, 1400);
              }
            }
          }, 1200);
        }, 800);
      }, [currentRound]);
      
      // Handle DAG completion
      const handleDAGComplete = useCallback((initialDAG, finalDAG, confidence) => {
        setDagData({ initial: initialDAG, final: finalDAG, confidence: confidence });
        setDagCompleted(true);
        setShowDAG(false);
        
        // Send DAG data to Qualtrics
        sendDataToQualtrics('DAG_DATA', {
          initialDAG: initialDAG,
          finalDAG: finalDAG,
          confidence: confidence,
          completedAtRound: currentRound
        });
        
        // Continue to next round
        setTimeout(() => {
          setHideRateBox(true);
          setNextDayNumber(currentRound + 1);
          
          setTimeout(() => {
            setShowNewDay(true);
            
            setTimeout(() => {
              setShowNewDay(false);
              setHideRateBox(false);
              setCurrentRound(prev => prev + 1);
              setPhase('decision');
              setCurrentA(null);
              setCurrentX(null);
              setCurrentY(null);
              roundStartTimeRef.current = Date.now();
            }, 1000);
          }, 100);
        }, 500);
      }, [currentRound]);
      
      // Show loading screen while waiting for Qualtrics config
      if (!ready) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center">
            <div className="text-white text-xl">Loading...</div>
          </div>
        );
      }
      
      // Send final data when game completes
      if (phase === 'complete' && selectedPaymentRound !== null && history.length === CONFIG.totalRounds && !dataSentRef.current) {
        dataSentRef.current = true;
        const [pA, pX, pY] = history[selectedPaymentRound - 1];
        const selectedRoundPayment = -CONFIG.aCost * pA + CONFIG.yBonus * pY;
        
        sendDataToQualtrics('FINAL_DATA', {
          history: history,  // [[A, X, Y], [A, X, Y], ...]
          roundTimes: roundTimesRef.current,
          payment: history.map(([A, X, Y]) => -CONFIG.aCost * A + CONFIG.yBonus * Y),
          selectedPaymentRound: selectedPaymentRound,
          selectedRoundPayment: selectedRoundPayment,
          totalEarnings: totalEarnings,
          dagInitial: dagData.initial,
          dagFinal: dagData.final,
          dagConfidence: dagData.confidence
        });
        
        setTimeout(() => {
          sendDataToQualtrics('GAME_COMPLETE', { completed: true });
        }, 500);
      }
      
      // Show DAG drawing interface (loads from separate file)
      if (showDAG) {
        return (
          <DAGIframe
            onComplete={handleDAGComplete}
            playerName0={CONFIG.playerName0}
            playerName1={CONFIG.playerName1}
            playerIcon0={CONFIG.playerIcon0}
          />
        );
      }
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
          <div className="max-w-6xl mx-auto">
              <div className="bg-slate-800/50 backdrop-blur rounded-2xl p-6 mb-4 border border-slate-700 relative overflow-hidden">
              <NewDayOverlay show={showNewDay} dayNumber={nextDayNumber} />

              <div className="absolute top-4 left-4 bg-white/10 backdrop-blur rounded-xl px-4 py-2">
                <div className="text-white font-medium text-sm mb-1">Monday</div>
                <div className="flex items-center gap-3">
                  <div>
                    <span className="text-white/60 text-sm">Week</span>
                    <div className="text-white text-2xl font-bold">{currentRound}</div>
                  </div>
                  <div className="text-white/40 text-xl">/</div>
                  <div className="text-white/60 text-lg">{CONFIG.totalRounds}</div>
                </div>
                <div className="w-20 h-2 bg-white/20 rounded-full mt-2 overflow-hidden">
                  <div
                    className="h-full bg-gradient-to-r from-cyan-400 to-blue-500 transition-all duration-300"
                    style={{ width: `${(currentRound / CONFIG.totalRounds) * 100}%` }}
                  />
                </div>
              </div>

              <XYConnection
                X={currentX}
                Y={currentY}
                stats={stats}
                hideRateBox={hideRateBox}
              />
              
              <div className="text-center mt-4">
                <span className={`inline-block px-4 py-2 rounded-full text-sm font-medium ${
                  phase === 'decision' ? 'bg-blue-500/20 text-blue-300 border border-blue-500/30' :
                  phase === 'chemical' ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' :
                  'bg-green-500/20 text-green-300 border border-green-500/30'
                }`}>
                  {phase === 'decision' && `Morning: Will you drink ${CONFIG.playerName0}?`}
                  {phase === 'chemical' && `Reading your ${CONFIG.playerName1} level...`}
                  {phase === 'outcome' && `Later this day: ${currentY === 1 ? 'Energetic! üòä' : 'Tired üòî'}`}
                </span>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-4">
              <DrinkDecisionPanel 
                onChoice={handleChoice} 
                disabled={phase !== 'decision'}
                stats={stats}
              />
              <XStatsPanel stats={stats} currentX={currentX} />
              <CompactHistory history={history} />
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(<BeverageExperiment />);
  </script>
</body>
</html>
